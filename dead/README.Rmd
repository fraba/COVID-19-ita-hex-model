---
title: "Untitled"
output: github_document
---

```{r setup}
library(readr)
library(dplyr)
library(tidyr)
library(zoo)
library(data.table)
library(parallel)
library(gridExtra)
library(ggplot2)

raw_dat.df <- 
  read_csv("istat-4-may-2020/comuni_giornaliero.csv.zip", 
           locale = locale(encoding = "ISO-8859-1"))

length(unique(raw_dat.df$COD_PROVCOM))

to_include <- unique(raw_dat.df$COD_PROVCOM[raw_dat.df$T_20 != "n.d."])
length(to_include)

all_days <- unique(raw_dat.df$GE)
all_days <- all_days[!grepl("^04", all_days)]

m <- 
  expand.grid(to_include, 
              all_days, 
              paste0("M_", 15:20), 
              unique(raw_dat.df$CL_ETA))
colnames(m) <- c("COD_PROVCOM","GE", "year", "CL_ETA")
dt <- data.table(m, key=colnames(m))

dat.dt <- 
  raw_dat.df %>%
  dplyr::filter(COD_PROVCOM %in% to_include) %>%
  dplyr::select(COD_PROVCOM, CL_ETA, GE, M_15:M_20) %>% # MALE ONLY
  tidyr::gather(year, value, M_15:M_20) %>%
  data.table(key=colnames(m))

dat.dt <-
  merge(dat.dt, dt, all = T)
dat.dt$value[is.na(dat.dt$value)] <- "0"

dat_over70.dt <- 
  dat.dt %>%
  dplyr::filter(CL_ETA >= 15) %>%
  dplyr::mutate(value = as.numeric(value),
                date = as.Date(paste0(year,GE), format("M_%y%m%d"))) %>%
  dplyr::group_by(COD_PROVCOM, GE, year) %>%
  dplyr::summarize(value = sum(value, na.rm = T))

dat_over70.dt <-
  dat_over70.dt %>%
  dplyr::group_by(COD_PROVCOM, year) %>%
  dplyr::arrange(as.character(GE)) %>%
  dplyr::mutate(value_ma14 = rollmean(value, 14, align = 'right', fill = NA))

save(dat_over70.dt, file = "dat_over70.dt.RData")
```

```{r warning=F}
library(sf)
italy.sf <- 
  read_sf("../shapefile/Italy/Limiti01012020/Com01012020/Com01012020_WGS84.shp") %>%
  sf::st_simplify(preserveTopology = TRUE, dTolerance = 1000) %>%
  st_make_valid()

load("../grid/hex_ita_1km.sf.RData")
st_crs(hex_ita_1km.sf) <- st_crs(32632)

dat_over70_spread.dt <- 
  dat_over70.dt %>%
  dplyr::select(-value_ma14) %>%
  tidyr::pivot_wider(names_from = year, values_from = value)

dat_over70_spread.dt$GE <- 
  as.character(dat_over70_spread.dt$GE)
dat_over70_spread.dt$COD_PROVCOM <-
  as.character(dat_over70_spread.dt$COD_PROVCOM)


fun1 <- function(day) {
  this.dt <- 
    dat_over70_spread.dt %>% 
    dplyr::filter(GE == day)
  this.sf <- 
    merge(italy.sf, this.dt, 
          by.x = "PRO_COM_T", by.y = "COD_PROVCOM")
  return(this.sf)
}

these.sf <- lapply(all_days, fun1)
names(these.sf) <- all_days

fun2 <- function(i, these.sf, hex_ita_1km.sf) {
  this.sf <- these.sf[[i]]
  require(sf)
  hex_dead.df <- data.frame()
  for (year in c(paste0("M_", 15:20))) {
      this_sampling.sf <- 
        this.sf[this.sf[[year]]>0,]
      if (nrow(this_sampling.sf) == 0) {
        next
      }
      this_sample.sf <- 
        st_sample(this_sampling.sf, this_sampling.sf[[year]])
      this_res <- 
        as.data.frame(table(unlist(st_within(this_sample.sf, hex_ita_1km.sf))))
      
      this_res$year <- year
      this_res$day <- names(these.sf)[[i]]
      hex_dead.df <- rbind(hex_dead.df, this_res)
  }
  return(hex_dead.df)
}

cl <- makeCluster(10)

hex_dead.list <- parLapply(cl, 1:length(all_days), fun2, these.sf, hex_ita_1km.sf)

stopCluster(cl)

hex_dead.df <- bind_rows(hex_dead.list)
colnames(hex_dead.df)[1] <- "hex_id"
save(hex_dead.df, file = "hex_dead.df.RData")
```

```{r, fig.width = 9, fig.height=13}

plotFun <- function(day) {
  this.sf <- hex_ita_1km.sf
  this.sf$value <-
    hex_dead.df[hex_dead.df$day == day,]$Freq[match(this.sf$hex_id,
                                                    hex_dead.df[hex_dead.df$day == day,]$hex_id)]
  this.sf$value[is.na(this.sf$value)] <- 0
  return(ggplot(this.sf) + 
           geom_sf(aes(fill=value), colour = NA) + 
           scale_fill_distiller(palette="Spectral", direction = -1) +
           labs(fill = "Dead", caption = day) +
           theme(axis.text = element_blank(),
                 axis.ticks = element_blank()))
}

plots <- lapply(c("0101", "0115", "0131",
                  "0201", "0215", "0229",
                  "0301", "0315", "0331"), 
                plotFun)



do.call("grid.arrange", c(plots, ncol=3))

```



```{r, eval = F, include=F}
# sd(c(10, 11, 11, 10, 9))
# 
# 22 - mean(c(10, 11, 11, 10, 9)) / 
#   sd(c(10, 11, 11, 10, 9))

dat_over70_diff.dt <-
  dat_over70.dt %>%
  dplyr::select(-value) %>%
  # dplyr::filter(COD_PROVCOM == "016024") %>%
  tidyr::pivot_wider(names_from = year, values_from = value_ma14)

dat_over70_diff.dt$sd_15_19 <- 
  apply(dat_over70_diff.dt[,3:7], 1, FUN = sd)
dat_over70_diff.dt$mean_15_19 <- 
  apply(dat_over70_diff.dt[,3:7], 1, FUN = mean)
dat_over70_diff.dt$dist_sd <- 
  (dat_over70_diff.dt$M_20 - 
     dat_over70_diff.dt$mean_15_19) /
  dat_over70_diff.dt$sd_15_19

```

