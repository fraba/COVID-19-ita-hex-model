---
title: "Air quality (Covid-19 Research)"
author: "Francesco Bailo"
date: "25/04/2020"
output: html_document
---

# NOTE: Compile from command line 
R -e "Sys.setenv(RSTUDIO_PANDOC='/usr/lib/rstudio-server/bin/pandoc'); rmarkdown::render('README.Rmd',output_file='README.html')"

```{r libraries, message=F, warning=F}
library(dplyr)
library(knitr)
library(sf)
library(ggplot2)
library(viridis)
library(raster)
library(stars)
library(parallel)
library(gridExtra)

knitr::opts_chunk$set(echo = TRUE, message=F, warning=F)
```

```{r}
r.stars <- 
  read_stars("adaptor.cams_regional_fc.retrieve-1588048559.0080748-2499-7-2786eb2f-f42f-46e1-953e-8b830990de9b.nc")
vars <- names(r.stars)
vars
```

```{r}
dates <- seq(as.Date("2020-01-01"), as.Date("2020-04-26"), by = 1)
dates
```

```{r}

load("../grid/hex_ita_10km.sf.RData")
st_crs(hex_ita_10km.sf) <- 32632
hex_ita_1km.sf <- st_transform(hex_ita_1km.sf, 4326)

fun1 <- function(i, var, hex_ita_1km.sf, dates) {
  require(raster)
  require(sf)
  r <- raster(sprintf('%s.tiff', var), band = i)
  res <- raster::extract(r, hex_ita_1km.sf, fun = mean, weights  = T)
  return(data.frame(hex_id = 1:nrow(hex_ita_1km.sf),
                    date = dates[i],
                    var = var,
                    value = res[,1]))
}

cl <- makeCluster(10)
airquality.df <- data.frame(stringsAsFactors = F)
for (var in vars) {
  res.list <- parLapply(cl, 1:length(dates), fun1, var, hex_ita_1km.sf, dates)
  res.df <- bind_rows(res.list)
  airquality.df <- rbind(airquality.df, res.df)
}

stopCluster(cl)

save(airquality.df, file = "airquality.df.RData")

```

```{r}
fun2 <- function(i) {
  smpl_var <- sample(unique(airquality.df$var), 1)
  smpl_date <- sample(unique(airquality.df$date), 1)
  smpl_dat <- airquality.df %>% filter(var == smpl_var & date == smpl_date)
  hex_ita_1km.sf$smpl_value <- smpl_dat$value
  return(ggplot(hex_ita_1km.sf) +
           geom_sf(aes(fill = smpl_value), colour = NA) +
           scale_fill_distiller(palette = "Spectral", direction = 1) +
           theme(axis.text = element_blank(),
                 axis.ticks = element_blank()) +
           labs(caption = paste0(smpl_var, " ", smpl_date), fill = NULL) +
           guides(fill = FALSE))
}

plot.list <- lapply(1:25, fun2)
do.call("grid.arrange", c(plot.list, ncol=5))
```


# Temperature & Humidity


gdal_translate -a_srs EPSG:4326 .grib -of Gtiff .tif


Files:
adaptor.mars.internal-1594365010.3592808-30630-21-f57d78e6-5991-4541-b2e8-d2d6881bde25.grib
adaptor.mars.internal-1594365022.5107076-24267-22-6f64132e-6be2-435e-8f0c-afc486589c1f.grib
adaptor.mars.internal-1594365033.0280426-24640-3-05ed6dec-ddcd-458c-b27c-bcf411e34fae.grib
adaptor.mars.internal-1594365045.745545-22240-36-7ba14d18-e5df-4f09-a6d7-6a9dad00c178.grib

Commands:
gdal_translate -a_srs EPSG:4326 adaptor.mars.internal-1594365022.5107076-24267-22-6f64132e-6be2-435e-8f0c-afc486589c1f.grib -of Gtiff adaptor.mars.internal-1594365022.5107076-24267-22-6f64132e-6be2-435e-8f0c-afc486589c1f.tif

gdal_translate -a_srs EPSG:4326 adaptor.mars.internal-1594365010.3592808-30630-21-f57d78e6-5991-4541-b2e8-d2d6881bde25.grib -of Gtiff adaptor.mars.internal-1594365010.3592808-30630-21-f57d78e6-5991-4541-b2e8-d2d6881bde25.tif

gdal_translate -a_srs EPSG:4326 adaptor.mars.internal-1594365045.745545-22240-36-7ba14d18-e5df-4f09-a6d7-6a9dad00c178.grib -of Gtiff adaptor.mars.internal-1594365045.745545-22240-36-7ba14d18-e5df-4f09-a6d7-6a9dad00c178.tif

gdal_translate -a_srs EPSG:4326 adaptor.mars.internal-1594365033.0280426-24640-3-05ed6dec-ddcd-458c-b27c-bcf411e34fae.grib -of Gtiff adaptor.mars.internal-1594365033.0280426-24640-3-05ed6dec-ddcd-458c-b27c-bcf411e34fae.tif

```{r}
load("../grid/hex_ita_10km.sf.RData")
st_crs(hex_ita_10km.sf) <- 32632
require(raster)
require(sf)
require(sp)

dates <- 
  seq(from = as.Date("2020-01-01"), 
      to = as.Date("2020-07-05"),
      by = "day")

prec.r <- 
  brick('adaptor.mars.internal-1594365010.3592808-30630-21-f57d78e6-5991-4541-b2e8-d2d6881bde25.tif')
names(prec.r) <- 
  seq(from = as.Date("2020-01-01"), 
      to = as.Date("2020-07-05"),
      by = "day")

temp.r <- 
  brick('adaptor.mars.internal-1594365022.5107076-24267-22-6f64132e-6be2-435e-8f0c-afc486589c1f.tif')
names(temp.r) <- 
  seq(from = as.Date("2020-01-01"), 
      to = as.Date("2020-07-05"),
      by = "day")

pres.r <- 
  brick('adaptor.mars.internal-1594365045.745545-22240-36-7ba14d18-e5df-4f09-a6d7-6a9dad00c178.tif')
names(pres.r) <- 
  seq(from = as.Date("2020-01-01"), 
      to = as.Date("2020-07-05"),
      by = "day")

dewp.r <- 
  brick('adaptor.mars.internal-1594365033.0280426-24640-3-05ed6dec-ddcd-458c-b27c-bcf411e34fae.tif')
names(dewp.r) <- 
  seq(from = as.Date("2020-01-01"), 
      to = as.Date("2020-07-05"),
      by = "day")

crs(r) <- 
  "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" 

ita.sp <- 
  readRDS("gadm36_ITA_0_sp.rds")

hex_ita_10km.sp <- 
  as_Spatial(hex_ita_10km.sf %>% st_transform(4326))

temp.extr <- 
  raster::extract(temp.r, hex_ita_10km.sp, 
                  fun = mean, weights  = T)

prec.extr <- 
  raster::extract(prec.r, hex_ita_10km.sp, 
                  fun = mean, weights  = T)

pres.extr <- 
  raster::extract(pres.r, hex_ita_10km.sp, 
                  fun = mean, weights  = T)

dewp.extr <- 
  raster::extract(dewp.r, hex_ita_10km.sp, 
                  fun = mean, weights  = T)


era5_climate_hex.df <- data.frame()

for (i in 1:length(dates)) {
  print(i)
  era5_climate_hex.df <-
    rbind(era5_climate_hex.df,
          data.frame(hex_id = 1:nrow(hex_ita_10km.sf),
                     date = dates[i],
                     var = 'temp',
                     value = temp.extr[,i]),
          data.frame(hex_id = 1:nrow(hex_ita_10km.sf),
                     date = dates[i],
                     var = 'prec',
                     value = prec.extr[,i]),
          data.frame(hex_id = 1:nrow(hex_ita_10km.sf),
                     date = dates[i],
                     var = 'pres',
                     value = pres.extr[,i]),
          data.frame(hex_id = 1:nrow(hex_ita_10km.sf),
                     date = dates[i],
                     var = 'dewp',
                     value = dewp.extr[,i]))
}

save(era5_climate_hex.df, file = "era5_climate_hex.df.RData")


test.sf <- 
  hex_ita_10km.sf

test.sf$value <- dewp.extr[,10]

ggplot(test.sf) + geom_sf(aes(fill = value), colour = NA)
```


